#!/usr/bin/env node
"use strict";var j=require("path");var R=require("fs/promises");var f=require("chalk");var Y=require("axios");var httpsProxyAgent=require("https-proxy-agent");var googleAuthLibrary=require("google-auth-library");var commander=require("commander");var ie=require("fs");function _interopDefault(e){return e&&e.__esModule?e:{default:e}}var j__default=_interopDefault(j);var R__default=_interopDefault(R);var f__default=_interopDefault(f);var Y__default=_interopDefault(Y);var ie__default=_interopDefault(ie);var q=Object.defineProperty,v=Object.defineProperties;var M=Object.getOwnPropertyDescriptors;var S=Object.getOwnPropertySymbols;var k=Object.prototype.hasOwnProperty,P=Object.prototype.propertyIsEnumerable;var G=(e,r,t)=>r in e?q(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,E=(e,r)=>{for(var t in r||(r={}))k.call(r,t)&&G(e,t,r[t]);if(S)for(var t of S(r))P.call(r,t)&&G(e,t,r[t]);return e},U=(e,r)=>v(e,M(r));var w=(e,r)=>{var t={};for(var o in e)k.call(e,o)&&r.indexOf(o)<0&&(t[o]=e[o]);if(e!=null&&S)for(var o of S(e))r.indexOf(o)<0&&P.call(e,o)&&(t[o]=e[o]);return t};var l=(e,r)=>()=>(e&&(r=e(e=0)),r);var z=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports);var u=(e,n,i)=>new Promise((r,t)=>{var o=e=>{try{l(i.next(e))}catch(e){t(e)}},a=e=>{try{l(i.throw(e))}catch(e){t(e)}},l=e=>e.done?r(e.value):Promise.resolve(e.value).then(o,a);l((i=i.apply(e,n)).next())});var C,h,T,g=l(()=>{C="hexo-seo-submit",h={baidu:"http://data.zz.baidu.com/urls",bing:"https://ssl.bing.com/webmaster/api.svc/pox/SubmitUrlBatch",google:"https://indexing.googleapis.com/batch"},T=`
`});var O,_=l(()=>{g();O=e=>u(void 0,null,function*(){return yield R__default.default.readFile(j__default.default.join(process.cwd(),e),"utf8")})});var Q,V,Z,y,b=l(()=>{Q=2e4,V=Y__default.default.create({timeout:Q,paramsSerializer:{}}),Z=V.request,y=Z});var $,B=l(()=>{b();g();$=(e,r)=>{let t=r,{site:o}=t,a=w(t,["site"]);return y({url:`${h.baidu}?site=${o}`,data:e,method:"post",params:a,headers:{"Content-type":"text/plain"}})}});var N,J=l(()=>{b();g();N=(e,r)=>{let{apiKey:t,siteUrl:o}=r;return y({url:h.bing,method:"post",params:{apiKey:t},data:{urlList:e,siteUrl:o},headers:{"Content-Type":"application/json; charset=utf-8"}})}});var te,D,K=l(()=>{b();g();te=e=>u(void 0,null,function*(){return yield(yield new googleAuthLibrary.GoogleAuth({credentials:{client_email:e.client_email,private_key:e.private_key.replace(/\\n/g,"\n")},scopes:["https://www.googleapis.com/auth/indexing"]}).getClient()).getAccessToken()}),D=c=>u(void 0,null,function*(){let{urlList:e,secretsConfig:r,proxy:t}=c,o={};if(t){let e=new httpsProxyAgent.HttpsProxyAgent(t);o.proxy=!1,o.httpsAgent=e,process.env.HTTPS_PROXY=t,process.env.HTTP_PROXY=t}let a=yield te(r),l=`===============${Math.round(Math.random()*2e5)}==`,n=e.map(e=>({body:JSON.stringify({url:e,type:"URL_UPDATED"})})),i=`
`,s=n.map(e=>`\r
--${l}${i}Content-Type: application/http ${i}Content-Transfer-Encoding: binary ${i}\r
POST /v3/urlNotifications:publish ${i}Content-Type: application/json ${i}accept: application/json ${i}Content-Length:${e.body.length}${i}\r
${e.body}`).join("");return y(E({method:"post",url:h.google,headers:{Authorization:`Bearer ${a.token}`,"Content-Type":`multipart/mixed; boundary=${l}`},data:s},o))})});var H,L=l(()=>{H=l=>new Promise((e,r)=>{if(!l){r(new Error("no config here"));return}let{file:t,accountKeysJSon:o,accountKeysJSonFile:a}=l;if(!t){r(new Error("Where are files?"));return}if(!o&&!a){r(new Error("Where are accountKeys?"));return}e("done")})});var re,I,F=l(()=>{K();L();g();re=s=>u(void 0,null,function*(){try{yield H(s)}catch(e){return Promise.reject(e.message)}let{file:e,accountKeysJSon:r,accountKeysJSonFile:t,proxy:o}=s,a=r;t&&(a=yield R__default.default.readFile(j__default.default.join(process.cwd(),t),"utf8"));let l=JSON.parse(a||"");l.private_key=l.private_key.replace(/\\n/g,"\n");let n=yield R__default.default.readFile(e,"utf8");if(!n)return Promise.reject(new Error("no url to submit"));let i=n.split(T);return D({urlList:i,secretsConfig:l,proxy:o})}),I=re});var ce=z(r=>{g();_();B();J();F();var e=ie__default.default.readFileSync(j__default.default.join(process.cwd(),"package.json"),"utf8"),t=JSON.parse(e||"");commander.program.name(C).description("push url to search engine").version(t.version);commander.program.command("baidu").argument("[]").requiredOption("-t, --token <token>","push token.").requiredOption("-f, --file <file>","urls file path.").requiredOption("-s, --site <site>","blog site. Eg: https://ksh7.com").action((e,i)=>u(r,null,function*(){var l,n,r,t;try{let{token:e,file:r,site:t}=i,o=yield O(r),a=yield $(o,{token:e,site:t});console.log(f__default.default.bgGreen(`success ${(l=a==null?void 0:a.data)==null?void 0:l.success}; ${(n=a==null?void 0:a.data)==null?void 0:n.remain} remain`))}catch(e){console.error(f__default.default.red(((t=(r=e.response)==null?void 0:r.data)==null?void 0:t.message)||e.message)),process.exit(1)}}));commander.program.command("bing").argument("[]").requiredOption("-k, --key <key>","push api key.").requiredOption("-f, --file <file>","url json file path.").action((e,a)=>u(r,null,function*(){var r;let{key:t,file:o}=a;try{let e=yield O(o),r=JSON.parse(e||"");yield N(r==null?void 0:r.urlList,{siteUrl:r==null?void 0:r.siteUrl,apiKey:t}),console.log(f__default.default.bgGreen("bing: push success"))}catch(e){console.error(f__default.default.red(`bing error: ${((r=e==null?void 0:e.response)==null?void 0:r.data)||e.message}`)),process.exit(1)}}));commander.program.command("google").argument("[]").requiredOption("-f, --file <file>","url file path.").option("-p, --proxy <proxy>","https proxy url. Eg: http[s]://127.0.0.1:7890").option("-mail, --client_email <client_email>","accountKeysJSon.client_email").option("-key, --private_key <private_key>","accountKeysJSon.private_key").option("-kf, --accountKeysJSonFile <accountKeysJSonFile>","accountKeysJSonFile path").action((e,s)=>u(r,null,function*(){var t,r;let{accountKeysJSonFile:o,client_email:a,private_key:l,proxy:n,file:i}=s;if(!o&&!(a&&l)){console.error("google error: miss credentials"),process.exit(1);return}try{let r={};a&&l?r.accountKeysJSon=JSON.stringify({client_email:a,private_key:l}):r.accountKeysJSonFile=o;if(r.accountKeysJSon){let e=JSON.parse(r.accountKeysJSon);e.private_key=e.private_key.replace(/\\n/g,"\n");r.accountKeysJSon=JSON.stringify(e)}let e=yield I(U(E({file:j__default.default.join(process.cwd(),i)},r),{proxy:n}));(t=e==null?void 0:e.data)!=null&&t.includes(200)?console.log(f__default.default.bgGreen("google: push success")):(console.error(f__default.default.red(`google failed ${e==null?void 0:e.data}`)),process.exit(1))}catch(e){console.log(f__default.default.red(`google error: ${((r=e==null?void 0:e.response)==null?void 0:r.data.error.message)||e.message}`)),process.exit(1)}}));commander.program.parse()});var index=ce();module.exports=index;